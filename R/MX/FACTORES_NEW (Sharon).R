rm(list = ls(all=T))

library(RJDBC)
library(dplyr)
library(sqldf)
library(xlsx)
library(tidyr)
library(data.table)

RUTA <- "G:/Shared drives/RETAIL REGULAR/PRODUCCION/SAMPLE INSPECTION/45 - HOME/2020020 - AGO20/FINAL/"

ESTIMADAS <- read.csv(paste0(RUTA,"/ESTIMADAS_45_AGO20 - Insumo2.csv"))

NOM <- "HOME_45_PREFACTORES_AGO20AFI"
###########################################################################
NIVEL<- 1
# 0: TIENDA
# 1: CELDA

GROUP_A<-c("CATEGORIA","FABRICANTE")
###################    "CATEGORIA","SEGMENTO","FABRICANTE","MARCA"  ##########################

PERIODOS <- c(1110,1114,1119,1123,1127,1132)
## 1010,1014,1018,1023,1027,1032,1036,1040,1045,1049,1053,1058,1062,1066,1071,1075,1079,1084,1088,1092,1097,1101,1105,1110,1114,1119
PER_IN <- 1132

TICKETS <- c(103594:103598)

CHARVALUEID <- c(51361246,72550365,53289076,53141596,51329969,53412130,52135816,51936884,53138344,51101034,72550364,51536990)  #####  CHARVALUEID  #########
## CHARVALUEID <- c(51361246,72550365,53289076,53141596)  HOME ACV
### 51100940,72550452,52690043,53139171,70294858,70294861
## 52140860
MERCADOS <- "1216147,1216148,1216146,1216163,1216150,1216168,1216155,1216160,1216159,
               1216158,1216151,1216178,1216179,1216153,1216162,1216149,1216177,1216166,
               1216154,1216176,1216161,1216174,1216171,1216173,1216172,1216165,1216167"## PAPELERIAS 1294918
## ARMS 1333848,1333851,1333855,1341340,1341341,1333853,1333858,1341311,1333879,1341309,1341310,1341308,1333877,1333882,1341316,1341317,1341315,1341321,1341319,1333863,1341314,1333861,1341313,1341312,1333865,1333940,1346829,1346828,1333918,1333917,1333921,1333922,1333927,1333932,1333930,1333943,1333942,1333939,1333938,1333934,1349230,1349228,1349229,1349222,1349221,1349220,1349224,1349225,1349226,1346811,1346809,1346813,1346810,1346812,1346804,1346806,1346807,1346803,1346805,1333787,1333790,1333785,1333799,1333794,1333797,1350727,1333808,1333810,1333814,1333816,1333821,1333818,1333835,1333832,1333828,1333826,1333824
##H&B 1178534,1178536,1178535,1178560,1178531,1178564,1178546,1178555,1178556,1178557,1178537,1178551,1178550,1178547,1178558,1178532,1178552,1178562,1178545,1178549,1178559,1178541,1178542,1178543,1178540,1178565,1178563,1178689,1178687,1178684,1178686,1178685,1178688
##PHARMA 1318715,1318713,1318714,1318691,1318709,1318696,1318700,1318689,1318688,1318690,1318710,1318706,1318704,1318702,1318693,1318716,1318707,1318695,1318701,1318705,1318692,1318685,1318684,1318682,1318683,1318698,1318697,1318668,1318664,1318665,1318669,1318667,1318666
##HOME 1216147,1216148,1216146,1216163,1216150,1216168,1216155,1216160,1216159,1216158,1216151,1216178,1216179,1216153,1216162,1216149,1216177,1216166,1216154,1216176,1216161,1216174,1216171,1216173,1216172,1216165,1216167
##BEVERAGES 1220849,1220848,1220850,1220824,1220837,1220827,1220830,1220842,1220843,1220841,1220838,1220836,1220834,1220832,1220822,1220839,1220833,1220829,1220831,1220835,1220821,1220847,1220846,1220844,1220845,1220826,1220828,1220852,1220856,1220854,1220855,1220853,1220857
##CONFECTIONERY 1178645,1178647,1178646,1178641,1178649,1178669,1178652,1178640,1178639,1178638,1178643,1178662,1178664,1178651,1178636,1178648,1178661,1178667,1178653,1178663,1178635,1178656,1178659,1178657,1178658,1178666,1178668,1178678,1178675,1178676,1178679,1178674,1178677
##FOOD 1178966,1178964,1178965,1178973,1178960,1178957,1178951,1178970,1178971,1178969,1178962,1178979,1178978,1178953,1178974,1178961,1178977,1178955,1178952,1178976,1178972,1178947,1178948,1178946,1178949,1178958,1178956
##DAIRY 1220265,1220264,1220263,1220268,1220261,1220287,1220256,1220270,1220272,1220271,1220266,1220278,1220276,1220257,1220273,1220260,1220279,1220289,1220258,1220277,1220274,1220283,1220285,1220284,1220282,1220288,1220290
##DIAPERS 1404641,1404642,1404643,1404665,1404639,1404652,1404671,1404663,1404664,1404662,1404638,1404658,1404657,1404669,1404666,1404637,1404656,1404653,1404670,1404659,1404667,1404647,1404649,1404646,1404648,1404651,1404654,1404679,1404683,1404678,1404681,1404680,1404682
## PAPELERIAS 1294921,1294920,1294922,1294925,1294926,1294924


driver <- JDBC(driverClass = "oracle.jdbc.OracleDriver"
               , classPath = "C:/64 bits/sqldeveloper-17.3.1.279.0537-x64/sqldeveloper/jdbc/lib/ojdbc8.jar"       
               , identifier.quote = "'")  

conn_m <- dbConnect(drv = driver
                    , url = "jdbc:oracle:thin:@oravalplc01scan.enterprisenet.org:1535/VALPLC01"
                    , user = "NRSP_GUEST"
                    , password = "NRSP_GUEST")

conn_s <- dbConnect(drv = driver
                    , url = "jdbc:oracle:thin:@orasirplc01scan.enterprisenet.org:1521/SIRPLC01"
                    , user = "SIRVALREAD_MX"
                    , password = "Zl7KIAWz")

ItemTOTAL<-dbGetQuery(conn_s,paste0("SELECT * FROM
                                         (SELECT
                                         B.F_NCV_NAN_KEY,
                                         A.AC_CHARVALUETAG,
                                         A.NC_CHARID
                                         FROM VLDIMDB_MX.CHARVALS A
                                         JOIN VLDIMDB_MX.NANCHARVALS B on (A.NC_CHARID=B.NC_CHARID and a.NC_CHARVALUEID=b.NC_CHARVALUEID)
                                         WHERE A.NC_CHARID IN (57153,57030,56982,56985) AND F_NCV_NAN_KEY IN (SELECT distinct B.F_NCV_NAN_KEY FROM VLDIMDB_MX.CHARVALS A
                                         JOIN VLDIMDB_MX.NANCHARVALS B on (A.NC_CHARID=B.NC_CHARID and a.NC_CHARVALUEID=b.NC_CHARVALUEID)
                                         WHERE
                                         A.NC_CHARVALUEID IN (",paste(CHARVALUEID,collapse=","),") ))
                                         PIVOT (MAX(AC_CHARVALUETAG) FOR NC_CHARID IN (57153 AS CATEGORIA,57030 AS SEGMENTO,56982 AS FABRICANTE,56985 AS MARCA))
                                         "))

SHO_EXTERNAL <- dbGetQuery(conn_m, "SELECT SHO_ID, SHO_EXTERNAL_CODE AS SHO_EXTERNAL
                             FROM MADRAS_DATA.TRSH_SHOP
                             WHERE SHO_CCH_COU_CODE = 'MX'
                             AND (SHO_EXTERNAL_CODE LIKE '231%' OR SHO_EXTERNAL_CODE LIKE '233%')")


Tiempo_tot<-Sys.time()
DWH_FINAL<-data.frame()
TMMS<-data.frame()

for (PERIODO in PERIODOS){
  
  TMMS_1 <- dbGetQuery(conn_m, paste0("SELECT DISTINCT MSR_TPR_ID, MSR_MAS_ID, B.MAS_DESCRIPTION, MSR_CEL_ID, D.CEL_DESCRIPTION, C.CIN_ACV_TURNOVER, MSR_SHO_ID, MSR_ACV_TURNOVER, MSR_X_FACTOR, MSR_Z_FACTOR
                              FROM MADRAS_DATA.TMMS_MS_RESOLUTION A
                              LEFT JOIN MADRAS_DATA.TMMS_MARKET_SEGMENT B ON A.MSR_MAS_ID = B.MAS_ID
                              LEFT JOIN MADRAS_DATA.TMXP_CELL_INDUSTRY C ON A.MSR_CEL_ID = C.CIN_CEL_ID AND A.MSR_TPR_ID = C.CIN_TPR_ID
                              LEFT JOIN MADRAS_DATA.TMXP_CELL D ON A.MSR_CEL_ID = D.CEL_ID
                              WHERE MSR_TPR_ID  = ",PERIODO," 
                              AND MSR_MAS_ID IN (", MERCADOS,")"))
  
  
  TMMS_1 <- left_join(TMMS_1, SHO_EXTERNAL, by=c("MSR_SHO_ID"="SHO_ID"))
  
  tiendas<- sqldf("select distinct SHO_EXTERNAL as tienda from TMMS_1")
  ayu<-trunc(length.POSIXlt(tiendas)/1000)+1
  
  
  for (i in 1:ayu){
    
    lim_inf<-1000*(i-1)
    t1<-sqldf(paste0("select tienda from tiendas limit ",lim_inf,",1000"))
    a<-paste0("'",paste(t1[,"tienda"],collapse = "','"),"'")
    
    DWH <- dbGetQuery(conn_s, paste0("SELECT nc_periodid-989 as DWH_TPR_ID,AC_NSHOPID AS TIENDA,F_NAN_KEY,a.NC_CHARVALUEID as CATEGORIA2, a.AC_CHARVALUETAG AS CATEG_DESC,NC_SLOT4 AS VENTAS_UNIDAD,  NC_SLOT4*NC_SLOT3 AS VENTAS_VALOR 
                              from VLDRAWDATA_MX.RAWDATA_MM C
                                          JOIN VLDIMDB_MX.NANCHARVALS B ON B.F_NCV_NAN_KEY=C.F_NAN_KEY
                                          JOIN VLDIMDB_MX.CHARVALS A On (A.NC_CHARID=B.NC_CHARID and a.NC_CHARVALUEID=b.NC_CHARVALUEID)
                                          WHERE AC_DTGROUP LIKE 'AUDIT_DTYPE' and nc_periodid = ",PERIODO,"+989 and A.NC_CHARID = 57153 AND F_NAN_KEY IN (SELECT
                                          B.F_NCV_NAN_KEY
                                          FROM VLDIMDB_MX.CHARVALS A
                                          JOIN VLDIMDB_MX.NANCHARVALS B on (A.NC_CHARID=B.NC_CHARID and a.NC_CHARVALUEID=b.NC_CHARVALUEID)
                                          WHERE A.NC_CHARID =57153 
                                          AND A.NC_CHARVALUEID IN (",paste(CHARVALUEID,collapse =","),"))
                                          AND AC_NSHOPID IN (",a,")
                                         "))%>%
      left_join(ItemTOTAL, by = c("F_NAN_KEY"="F_NCV_NAN_KEY"))
    
    DWH_FINAL <- rbind(DWH_FINAL, DWH)    
    print(i)
  }  
  
  TMMS <- rbind(TMMS, TMMS_1)    
  print(PERIODO)
}

Sys.time()-Tiempo_tot

MC <- group_by(TMMS,SHO_EXTERNAL)%>%
  summarise(PERIODOS=n())%>%
  mutate(MC=ifelse(PERIODOS==26,"SI","NO"))

FACTOR_FIJO <- filter(TMMS, MSR_TPR_ID == get("PER_IN"))%>%
  select(SHO_EXTERNAL, FACTOR_MC=MSR_X_FACTOR)

MC_FACTOR <- left_join(MC, FACTOR_FIJO, by="SHO_EXTERNAL")


########### CONSULTA DE TICKETS

AFI <- dbGetQuery(conn_s,paste0("select NC_PERIODID-989 AS PERIODO, AC_NSHOPID AS TIENDA, F_NAN_KEY AS ITEM,NC_SLOT1 AS NEW_INV, NC_SLOT2 AS NEW_COMPRAS, NC_SLOT4 AS NEW_VENTAS, NC_SLOT3*NC_SLOT4 AS NEW_VENTAS_VALOR from vldsys_mx.rawdata_corrections_mm
where nc_TICKET in (",paste(TICKETS,collapse=","),")"))

AFI <- group_by(AFI,PERIODO,TIENDA,ITEM)%>%summarise(NEW_VENTAS=sum(NEW_VENTAS,na.rm=T),NEW_VENTAS_VALOR=sum(NEW_VENTAS_VALOR,na.rm=T))%>%ungroup()

DWH_FINAL<-DWH_FINAL%>%left_join(AFI, by = c("DWH_TPR_ID"="PERIODO","TIENDA","F_NAN_KEY"="ITEM")) %>%mutate(UNIDAD_SUG=ifelse(is.na(NEW_VENTAS),VENTAS_UNIDAD,NEW_VENTAS),VALOR_SUG=ifelse(is.na(NEW_VENTAS_VALOR),VENTAS_VALOR,NEW_VENTAS_VALOR))
DWH_FINAL<-DWH_FINAL%>% mutate(UNIDAD_SUG=ifelse(is.na(UNIDAD_SUG),VENTAS_UNIDAD,UNIDAD_SUG),VALOR_SUG=ifelse(is.na(VALOR_SUG),VENTAS_VALOR,VALOR_SUG)) %>% mutate(LIN_CORR=ifelse(VENTAS_UNIDAD==UNIDAD_SUG,0,1)) %>% mutate(TOT_LIN=1)
DWH_FINAL <- select(DWH_FINAL,-NEW_VENTAS,-NEW_VENTAS_VALOR)

#####################################################################
#sqldf("select DWH_TPR_ID, sum(VENTAS_VALOR) from DWH_FINAL group by DWH_TPR_ID")
#sqldf("select MSR_TPR_ID, sum(VENTAS_VALOR) from TOTAL group by MSR_TPR_ID")


AYU_G<-c("DWH_TPR_ID","TIENDA")
AYU_S<-c( "MSR_TPR_ID","MSR_CEL_ID","CEL_DESCRIPTION","MSR_SHO_ID", "CIN_ACV_TURNOVER", "MSR_X_FACTOR","MSR_Z_FACTOR","SHO_EXTERNAL","MSR_ACV_TURNOVER","LIN_CORR","TOT_LIN","VENTAS_VALOR","VENTAS_UNIDAD","VALOR_SUG","UNIDAD_SUG","VENTAS_MC","VVP","VUP","VVP_AFI","VUP_AFI","MSR_MAS_ID","MAS_DESCRIPTION","ACV_PROY","TIPO")
GROUP1<-c(AYU_G,GROUP_A)
SELECT1<-c(AYU_S,GROUP_A)

########################################################################
DWH_RESUMEN <- DWH_FINAL%>%group_by_at(GROUP1)%>%
  summarise(VENTAS_VALOR=sum(VENTAS_VALOR,na.rm=T),
            VENTAS_UNIDAD=sum(VENTAS_UNIDAD,na.rm=T),
            UNIDAD_SUG=sum(UNIDAD_SUG,na.rm=T),
            VALOR_SUG=sum(VALOR_SUG,na.rm=T),
            LIN_CORR=sum(LIN_CORR,na.rm=T),
            TOT_LIN=sum(TOT_LIN,na.rm=T)) %>% filter(VALOR_SUG>0 | VENTAS_VALOR>0)

colnames(MC_FACTOR)
colnames(MC_FACTOR)<-c("SHO_EXTERNAL","PERIODOS","MC","FACTOR_MC")

CONSOL <- left_join(TMMS,DWH_RESUMEN, by=c("MSR_TPR_ID"="DWH_TPR_ID", "SHO_EXTERNAL"="TIENDA"))%>%
  left_join(MC_FACTOR, by=c("SHO_EXTERNAL"))%>%
  mutate(VENTAS_VALOR=ifelse(is.na(VENTAS_VALOR),0,VENTAS_VALOR),
         VENTAS_UNIDAD=ifelse(is.na(VENTAS_UNIDAD),0,VENTAS_UNIDAD),
         UNIDAD_SUG=ifelse(is.na(UNIDAD_SUG),0,UNIDAD_SUG),
         VALOR_SUG=ifelse(is.na(VALOR_SUG),0,VALOR_SUG),
         LIN_CORR=ifelse(is.na(LIN_CORR),0,LIN_CORR),
         TOT_LIN=ifelse(is.na(TOT_LIN),0,TOT_LIN),
         VENTAS_MC=ifelse(MC=="SI",FACTOR_MC*VENTAS_VALOR,0),
         VVP=MSR_X_FACTOR*VENTAS_VALOR,
         VUP=MSR_X_FACTOR*VENTAS_UNIDAD,
         VVP_AFI=MSR_X_FACTOR*VALOR_SUG,
         VUP_AFI=MSR_X_FACTOR*UNIDAD_SUG,
         ACV_PROY=MSR_X_FACTOR*MSR_ACV_TURNOVER,
         SHO_EXTERNAL=as.numeric(SHO_EXTERNAL),
         TIPO=ifelse(SHO_EXTERNAL<2330000000,"AUDIT","FT"))%>%
  select(SELECT1)%>%
  left_join(ESTIMADAS, by=c("MSR_TPR_ID","SHO_EXTERNAL"))%>%
  mutate(TIPO_ESTIMACION2=ifelse(is.na(TIPO_ESTIMACION),"NO ESTIMADA",TIPO_ESTIMACION))


if(NIVEL==1){GROUP2<-c(c( "MSR_TPR_ID","MSR_MAS_ID","MAS_DESCRIPTION","CEL_DESCRIPTION", "TIPO","TIPO_ESTIMACION"),GROUP_A);CONSOL2<-CONSOL%>%group_by_at(GROUP2)%>%
  summarise(VENTAS_VALOR=sum(VENTAS_VALOR,na.rm=T),
            VENTAS_UNIDAD=sum(VENTAS_UNIDAD,na.rm=T),
            VALOR_SUG=sum(VALOR_SUG,na.rm=T),
            UNIDAD_SUG=sum(UNIDAD_SUG,na.rm=T),
            VENTAS_MC=sum(VENTAS_MC,na.rm=T),
            VVP=sum(VVP,na.rm=T),
            VUP=sum(VUP,na.rm=T),
            VVP_AFI=sum(VVP_AFI,na.rm=T),
            VUP_AFI=sum(VUP_AFI,na.rm=T),
            LIN_CORR=sum(LIN_CORR,na.rm=T),
            TOT_LIN=sum(TOT_LIN,na.rm=T)
  )}

fwrite(CONSOL,paste0(RUTA,NOM,".csv"), col.names = TRUE)
shell.exec(paste0(RUTA,NOM,".csv"))
