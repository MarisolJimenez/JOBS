rm(list = ls(all=T))

library(RJDBC)
library(dplyr)
library(sqldf)
library(xlsx)
library(tidyr)
library(data.table)
library(gWidgets)
library(gWidgets2)
library(gWidgets2RGtk2)

driver <- JDBC(driverClass = "oracle.jdbc.OracleDriver"
               , classPath = "C:/64 bits/sqldeveloper-17.3.1.279.0537-x64/sqldeveloper/jdbc/lib/ojdbc8.jar"       
               , identifier.quote = "'")  

conn_m <- dbConnect(drv = driver
                    , url = "jdbc:oracle:thin:@oravalplc01scan.enterprisenet.org:1535/VALPLC01"
                    , user = "NRSP_GUEST"
                    , password = "NRSP_GUEST")

per1 <- as.numeric(ginput("Ingrese el periodo"))
var <- 1

for(per in per1)
{
tmms_papa <- dbGetQuery(conn_m, paste0("SELECT DISTINCT * FROM MADRAS_DATA.TMMS_MS_RESOLUTION
                                         WHERE MSR_MAS_ID IN (1216143,1216144,1216145,1216146,1216147,1216148,
                                         1216149,1216150,1216151,1216152,1216153,1216154,1216155,1216156,1216157,
                                         1216158,1216159,1216160,1216161,1216162,1216163,1216164,1216165,1216166,
                                         1216167,1216168,1216169,1216170,1216171,1216172,1216173,1216174,1216175,
                                         1216176,1216177,1216178,1216179)
                                       AND MSR_TPR_ID = ",per))

##H&B 1178544,1178553,1178530,1178548,1178538,1178561,1178533,1178534,1178536,1178535,1178560,1178531,1178564,1178546,1178554,1178555,1178556,1178557,1178537,1178551,1178550,1178547,1178558,1178532,1178552,1178562,1178545,1178549,1178559,1178529,1178539,1178541,1178542,1178543,1178540,1178565,1178563
##DIAPERS 1404635,1404636,1404637,1404638,1404639,1404640,1404641,1404642,1404643,1404644,1404645,1404646,1404647,1404648,1404649,1404650,1404651,1404652,1404653,1404654,1404655,1404656,1404657,1404658,1404659,1404660,1404661,1404662,1404663,1404664,1404665,1404666,1404667,1404668,1404669,1404670,1404671
tmms_audit <- dbGetQuery(conn_m, paste0("SELECT DISTINCT * FROM MADRAS_DATA.TMMS_MS_RESOLUTION
                                         WHERE MSR_MAS_ID IN (1424296,1424302,1424304,1424306,1424307,1424305,1424308,1424303,1424309,1424318,1424320,1424321,1424319,1424310,1424313,1424314,1424315,1424316,1424311,1424312,1424317,1424322,1424323,1424324,1424325,1424326,1424327,1424328,1424329,1424332,
                                         1424330,1424331,1424297,1424298,1424299,1424300,1424301)
                                         AND MSR_TPR_ID = ",per))
##H&B 1424194,1424206,1424200,1424205,1424195,1424204,1424215,1424172,1424175,1424181,1424227,1424217,1424218,1424212,1424229,1424166,1424193,1424190,1424216,1424222,1424225,1424211,1424226,1424214,1424224,1424221,1424210,1424223,1424228,1424163,1424213,1424178,1424169,1424184,1424187,1424219,1424220
##DIAPERS 20016190,20016207,20016208,20016210,20016209,20016211,20016226,20016227,20016228,20016191,20016192,20016224,20016225,20016222,20016223,20016202,20016203,20016206,20016205,20016204,20016197,20016199,20016198,20016201,20016200,20016212,20016213,20016230,20016229,20016231,20016214,20016215,20016216,20016193,20016196,20016195,20016194
tmms_ft <- dbGetQuery(conn_m, paste0("SELECT DISTINCT * FROM MADRAS_DATA.TMMS_MS_RESOLUTION
                                         WHERE MSR_MAS_ID IN (1424267,1424280,1424282,1424283,1424285,1424284,20021777,1424286,1424281,1424289,20028532,1424291,1424290,1424274,1424276,1424279,1424278,1424277,20028530,20021776,1424275,1424287,20028531,20021778,1424288,1424268,1424269,1424270,1424272,
                                         1424273,1424271,1424292,1424293,20021779,1424294,1424295)
                                         AND MSR_TPR_ID = ",per))
##1414986,1415000,1414989,1414996,1414980,1414978,1414990,1414993,1414991,1414992,1415005,1414995,1414979,1414988,1415001,1415004,1415003,1415002,1414994,1414998,1414997,20028426,20021609,20021608,20021607,20021606,1414987,1414999,20028427,1414977,1414981,1414985,1414983,1414982,1414984,20028425
##DIAPERS 20061676,20016157,20016182,20016183,20016189,20016184,20016185,20016187,20016186,20016188,20016166,20016167,20016170,20016168,20016171,20016169,20016179,0,20016181,20016180,0,20016158,20016161,20016162,20016160,20016159,20016172,20016174,20016175,20016176,20016177,20016178,20016173,0,20016163,0,20016165,20016164
if(var==1) {
  tmms_papa_t <- tmms_papa
  tmms_audit_t <- tmms_audit
  tmms_ft_t <- tmms_ft
  var <- var+1  
}else{
  tmms_papa_t <- rbind(tmms_papa_t, tmms_papa)
  tmms_audit_t <- rbind(tmms_audit_t, tmms_audit)
  tmms_ft_t <- rbind(tmms_ft_t, tmms_ft)
}
print(per)
}

resumen_papa <- group_by(tmms_papa_t, MSR_TPR_ID, MSR_MAS_ID)%>%
  summarise(TIENDAS_PAPA=n(), SUM_Z_PAPA=sum(MSR_Z_FACTOR), SUM_X_PAPA=sum(MSR_X_FACTOR))

resumen_audit <- group_by(tmms_audit_t, MSR_TPR_ID, MSR_MAS_ID)%>%
  summarise(TIENDAS_AUDIT=n(), SUM_Z_AUDIT=sum(MSR_Z_FACTOR), SUM_X_AUDIT=sum(MSR_X_FACTOR))

resumen_ft <- group_by(tmms_ft_t, MSR_TPR_ID, MSR_MAS_ID)%>%
  summarise(TIENDAS_FT=n(), SUM_Z_FT=sum(MSR_Z_FACTOR), SUM_X_FT=sum(MSR_X_FACTOR))


relacion <- read.csv("C:/Users/jima9001/Desktop/MX/HOME/RELACION_AUDIT_FK_HOME.csv")

resumen_final <- left_join(resumen_papa, relacion, by=c("MSR_MAS_ID"="MAS_PAPA"))%>%
                 left_join(resumen_audit, by=c("MSR_TPR_ID", "MAS_AUDIT"="MSR_MAS_ID"))%>%
                 left_join(resumen_ft, by=c("MSR_TPR_ID", "MAS_FT"="MSR_MAS_ID"))%>%
                 mutate(TIENDAS_FT=ifelse(is.na(TIENDAS_FT),0,TIENDAS_FT),
                        SUM_Z_FT=ifelse(is.na(SUM_Z_FT),0,SUM_Z_FT),
                        SUM_X_FT=ifelse(is.na(SUM_X_FT),0,SUM_X_FT),
                        TIENDAS=TIENDAS_AUDIT+TIENDAS_FT,
                        SUM_X=SUM_X_AUDIT+SUM_X_FT,
                        SUM_Z=SUM_Z_AUDIT+SUM_Z_FT,
                        VAR_TIENDA=TIENDAS-TIENDAS_PAPA,
                        VAR_X=SUM_X-SUM_X_PAPA,
                        VAR_Z=SUM_Z-SUM_Z_PAPA)

fwrite(resumen_final,"G:/Shared drives/RETAIL REGULAR/PRODUCCION/SAMPLE INSPECTION/45 - HOME/2020020 - AGO20/FINAL/CUADRE_FT_AUDIT.csv")
shell.exec("G:/Shared drives/RETAIL REGULAR/PRODUCCION/SAMPLE INSPECTION/45 - HOME/2020020 - AGO20/FINAL/CUADRE_FT_AUDIT.csv")
#solo impotran las columnas de VAR_X & VAR_Z